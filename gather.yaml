---
- name: Filter Linux Users Playbook
  hosts: all
  become: yes
  tasks:
    - name: Filter users from /etc/passwd
      shell: "grep -E '^[^:]+:.*:[^:]*[KCI][^:]*:' /etc/passwd | grep -v -E '^(cp6ipat1|qualys|unxqscan|unixsa|nobody|systemd-coredump|clevis|idadmin|dnsmasq):'"
      register: filtered_users

    - name: Display filtered users
      debug:
        var: filtered_users.stdout_lines
    - name: Expire passwords of filtered users
      user:
        name: "{{ item.split(':')[0] }}"
        password_expire: yes
      loop: "{{ filtered_users.stdout_lines }}"
      when: filtered_users.stdout_lines is defined and filtered_users.stdout_lines | length > 0

          
